<UserControl
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:previews="clr-namespace:ManaxClient.Controls.Previews"
    xmlns:issue="clr-namespace:ManaxClient.Models.Issue"
    xmlns:page="clr-namespace:ManaxClient.ViewModels.Pages.Issue"
    mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
    x:Class="ManaxClient.Views.Pages.Issue.IssuesPageView"
    x:DataType="page:IssuesPageViewModel">

    <UserControl.Resources>
        <DataTemplate x:Key="AutomaticChapterIssueTemplate" DataType="issue:ClientAutomaticIssueChapter">
            <previews:IssuePreview IssueColor="#DC3545"
                                   BadgeText="Automatique"
                                   Closable="False"
                                   Margin="0,0,0,8"
                                   Command="{Binding $parent[UserControl].((page:IssuesPageViewModel)DataContext).OnChapterIssueClicked}"
                                   CommandParameter="{Binding Chapter}">
                <previews:IssuePreview.Problem>
                    <MultiBinding StringFormat="{}{0}">
                        <Binding Path="Issue.Problem" />
                    </MultiBinding>
                </previews:IssuePreview.Problem>
                <previews:IssuePreview.Info>
                    <MultiBinding StringFormat="Chapitre: {0} • {1:dd/MM/yyyy HH:mm}">
                        <Binding Path="Chapter.FileName" />
                        <Binding Path="Issue.CreatedAt" />
                    </MultiBinding>
                </previews:IssuePreview.Info>
            </previews:IssuePreview>
        </DataTemplate>

        <DataTemplate x:Key="AutomaticSerieIssueTemplate" DataType="issue:ClientAutomaticIssueSerie">
            <previews:IssuePreview IssueColor="#DC3545"
                                   BadgeText="Automatique"
                                   Closable="False"
                                   Margin="0,0,0,8"
                                   Command="{Binding $parent[UserControl].((page:IssuesPageViewModel)DataContext).OpenSeriePage}"
                                   CommandParameter="{Binding Serie.Id}">
                <previews:IssuePreview.Problem>
                    <MultiBinding StringFormat="{}{0}">
                        <Binding Path="Issue.Problem" />
                    </MultiBinding>
                </previews:IssuePreview.Problem>
                <previews:IssuePreview.Info>
                    <MultiBinding StringFormat="Série: {0} • {1:dd/MM/yyyy HH:mm}">
                        <Binding Path="Serie.Title" />
                        <Binding Path="Issue.CreatedAt" />
                    </MultiBinding>
                </previews:IssuePreview.Info>
            </previews:IssuePreview>
        </DataTemplate>

        <DataTemplate x:Key="ReportedChapterIssueTemplate" DataType="issue:ClientReportedIssueChapter">
            <previews:IssuePreview IssueColor="#FD7E14"
                                   BadgeText="Signalé"
                                   Closable="True"
                                   Problem="{Binding Problem.Name}"
                                   Margin="0,0,0,8"
                                   CloseCommand="{Binding Close}"
                                   Command="{Binding $parent[UserControl].((page:IssuesPageViewModel)DataContext).OnChapterIssueClicked}"
                                   CommandParameter="{Binding Chapter}">
                <previews:IssuePreview.Info>
                    <MultiBinding StringFormat="Chapitre: {0} • Utilisateur: {1} • {2:dd/MM/yyyy HH:mm}">
                        <Binding Path="Chapter.FileName" />
                        <Binding Path="User.Username" />
                        <Binding Path="Issue.CreatedAt" />
                    </MultiBinding>
                </previews:IssuePreview.Info>
            </previews:IssuePreview>
        </DataTemplate>

        <DataTemplate x:Key="ReportedSerieIssueTemplate" DataType="issue:ClientReportedIssueSerie">
            <previews:IssuePreview IssueColor="#FD7E14"
                                   BadgeText="Signalé"
                                   Closable="True"
                                   Problem="{Binding Problem.Name}"
                                   Margin="0,0,0,8"
                                   CloseCommand="{Binding Close}"
                                   Command="{Binding $parent[UserControl].((page:IssuesPageViewModel)DataContext).OpenSeriePage}"
                                   CommandParameter="{Binding Serie.Id}">>
                <previews:IssuePreview.Info>
                    <MultiBinding StringFormat="Série: {0} • Utilisateur: {1} • {2:dd/MM/yyyy HH:mm}">
                        <Binding Path="Serie.Title" />
                        <Binding Path="User.Username" />
                        <Binding Path="Issue.CreatedAt" />
                    </MultiBinding>
                </previews:IssuePreview.Info>
            </previews:IssuePreview>
        </DataTemplate>
    </UserControl.Resources>

    <ScrollViewer>
        <StackPanel Margin="24" Spacing="24">
            <TextBlock Text="Gestion des Problèmes"
                       FontSize="28"
                       FontWeight="Bold"
                       Foreground="#212529" />

            <StackPanel Orientation="Horizontal" Spacing="16">
                <ToggleButton x:Name="AutomaticToggle"
                              Content="Automatiques"
                              IsChecked="{Binding ShowAutomaticIssues}"
                              Padding="12,8"
                              CornerRadius="8"
                              Background="#E9ECEF"
                              Foreground="#495057"
                              BorderThickness="0" />

                <ToggleButton x:Name="ReportedToggle"
                              Content="Signalés"
                              IsChecked="{Binding !ShowAutomaticIssues}"
                              Padding="12,8"
                              CornerRadius="8"
                              Background="#E9ECEF"
                              Foreground="#495057"
                              BorderThickness="0" />

                <Border Width="1" Height="24" Background="#DEE2E6" VerticalAlignment="Center" />

                <ToggleButton x:Name="ChapterToggle"
                              Content="Chapitres"
                              IsChecked="{Binding ShowChapterIssues}"
                              Padding="12,8"
                              CornerRadius="8"
                              Background="#E9ECEF"
                              Foreground="#495057"
                              BorderThickness="0" />

                <ToggleButton x:Name="SerieToggle"
                              Content="Séries"
                              IsChecked="{Binding !ShowChapterIssues}"
                              Padding="12,8"
                              CornerRadius="8"
                              Background="#E9ECEF"
                              Foreground="#495057"
                              BorderThickness="0" />
            </StackPanel>

            <StackPanel Spacing="16">
                <StackPanel IsVisible="{Binding ShowAutomaticIssues}">
                    <StackPanel IsVisible="{Binding ShowChapterIssues}" Spacing="12">
                        <TextBlock Text="Problèmes Automatiques - Chapitres"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="#495057" />

                        <ItemsControl ItemsSource="{Binding AllAutomaticChapterIssues}"
                                      ItemTemplate="{StaticResource AutomaticChapterIssueTemplate}" />

                        <TextBlock Text="Aucun problème automatique de chapitre trouvé"
                                   FontStyle="Italic"
                                   Foreground="#6C757D"
                                   IsVisible="{Binding AllAutomaticChapterIssues.Count, Converter={x:Static StringConverters.IsNullOrEmpty}}" />
                    </StackPanel>

                    <StackPanel IsVisible="{Binding !ShowChapterIssues}" Spacing="12">
                        <TextBlock Text="Problèmes Automatiques - Séries"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="#495057" />

                        <ItemsControl ItemsSource="{Binding AllAutomaticSerieIssues}"
                                      ItemTemplate="{StaticResource AutomaticSerieIssueTemplate}" />

                        <TextBlock Text="Aucun problème automatique de série trouvé"
                                   FontStyle="Italic"
                                   Foreground="#6C757D"
                                   IsVisible="{Binding AllAutomaticSerieIssues.Count, Converter={x:Static StringConverters.IsNullOrEmpty}}" />
                    </StackPanel>
                </StackPanel>

                <StackPanel IsVisible="{Binding !ShowAutomaticIssues}">
                    <StackPanel IsVisible="{Binding ShowChapterIssues}" Spacing="12">
                        <TextBlock Text="Problèmes Signalés - Chapitres"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="#495057" />

                        <ItemsControl ItemsSource="{Binding AllReportedChapterIssues}"
                                      ItemTemplate="{StaticResource ReportedChapterIssueTemplate}" />

                        <TextBlock Text="Aucun problème signalé de chapitre trouvé"
                                   FontStyle="Italic"
                                   Foreground="#6C757D"
                                   IsVisible="{Binding AllReportedChapterIssues.Count, Converter={x:Static StringConverters.IsNullOrEmpty}}" />
                    </StackPanel>

                    <StackPanel IsVisible="{Binding !ShowChapterIssues}" Spacing="12">
                        <TextBlock Text="Problèmes Signalés - Séries"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="#495057" />

                        <ItemsControl ItemsSource="{Binding AllReportedSerieIssues}"
                                      ItemTemplate="{StaticResource ReportedSerieIssueTemplate}" />

                        <TextBlock Text="Aucun problème signalé de série trouvé"
                                   FontStyle="Italic"
                                   Foreground="#6C757D"
                                   IsVisible="{Binding AllReportedSerieIssues.Count, Converter={x:Static StringConverters.IsNullOrEmpty}}" />
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </StackPanel>
    </ScrollViewer>
</UserControl>